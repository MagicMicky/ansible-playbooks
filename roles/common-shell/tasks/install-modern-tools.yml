---
# Install modern shell tools

- name: Install modern tools (macOS)
  community.general.homebrew:
    name:
      - fzf
      - zoxide
      - bat
      - eza
      - fd
      - ripgrep
    state: present
  when: is_macos

# Update apt cache (always runs, even in check mode to avoid package lookup failures)
- name: Update apt cache (Debian/Ubuntu)
  apt:
    update_cache: yes
  become: yes
  when: is_debian
  check_mode: no
  changed_when: false

- name: Install available modern tools (Debian/Ubuntu)
  apt:
    name:
      - ripgrep
      - git  # Required for fzf installation
    state: present
  become: yes
  when: is_debian

- name: Ensure .local/bin directory exists
  file:
    path: "{{ target_home }}/.local/bin"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes

- name: Check if fzf is installed
  stat:
    path: "{{ target_home }}/.fzf/bin/fzf"
  become: yes
  register: fzf_binary

- name: Install fzf with shell integration (Linux)
  shell: |
    git clone --depth 1 https://github.com/junegunn/fzf.git {{ target_home }}/.fzf
    cd {{ target_home }}/.fzf && ./install --bin
    ln -sf {{ target_home }}/.fzf/bin/fzf {{ target_home }}/.local/bin/fzf
  become: yes
  become_user: "{{ target_user }}"
  when:
    - not is_macos
    - not fzf_binary.stat.exists
  changed_when: true

- name: Add fzf to PATH in profile config
  blockinfile:
    path: "{{ target_home }}/.zshenv"
    create: yes
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - FZF"
    block: |
      # Add fzf to PATH
      export PATH="$HOME/.fzf/bin:$PATH"
  become: yes
  when: not is_macos

- name: Check if zoxide is installed
  stat:
    path: "{{ target_home }}/.local/bin/zoxide"
  become: yes
  register: zoxide_binary

- name: Install zoxide (Linux)
  shell: curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "{{ target_home }}"
  when:
    - not is_macos
    - not zoxide_binary.stat.exists
  changed_when: true

# Note: bat and eza installation on Linux may require additional steps
# They can be installed via cargo, snap, or downloaded from GitHub releases
# For now, we'll document this and handle it separately if needed
