---
# Shell configuration tasks

- name: Ensure .config/shell directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/shell"
    state: directory
    mode: '0755'

- name: Set machine type marker
  copy:
    content: "{{ machine_profile }}"
    dest: "{{ machine_type_file }}"
    mode: '0644'
  when: machine_profile is defined

- name: Set pro profile marker (work laptop)
  copy:
    content: ""
    dest: "{{ enable_pro_file }}"
    mode: '0644'
  when: machine_profile == "work"

- name: Check if dotfiles repository exists
  stat:
    path: "{{ dotfiles_repo }}"
  register: dotfiles_dir

- name: Clone dotfiles repository
  git:
    repo: "{{ dotfiles_repo_url }}"
    dest: "{{ dotfiles_repo }}"
    version: "{{ dotfiles_branch }}"
    update: yes
  when:
    - dotfiles_repo_url is defined
    - dotfiles_repo_url != ""
    - not dotfiles_dir.stat.exists

- name: Check if dotfiles repository exists
  stat:
    path: "{{ dotfiles_repo }}"
  register: dotfiles_dir_check

- name: Assert dotfiles repository exists
  assert:
    that:
      - dotfiles_dir_check.stat.exists
      - dotfiles_dir_check.stat.isdir
    fail_msg: |
      FATAL: Dotfiles repository not found at: {{ dotfiles_repo }}

      This is required for shell configuration. Please ensure:
      1. dotfiles_repo variable points to correct location
      2. Repository is cloned (or set dotfiles_repo_url to auto-clone)
      3. In Docker tests: repo should be mounted at /ansible/dotfiles
    success_msg: "Dotfiles repository found at {{ dotfiles_repo }}"

- name: Check if new .zshrc exists in dotfiles
  stat:
    path: "{{ dotfiles_repo }}/zsh/.zshrc"
  register: zshrc_file

- name: Assert .zshrc exists in dotfiles
  assert:
    that:
      - zshrc_file.stat.exists
      - zshrc_file.stat.isreg or zshrc_file.stat.islnk
    fail_msg: |
      FATAL: .zshrc not found at: {{ dotfiles_repo }}/zsh/.zshrc

      The dotfiles repository exists but is missing the .zshrc file.
      Please ensure you're on the correct branch ({{ dotfiles_branch }})
    success_msg: "Found .zshrc at {{ dotfiles_repo }}/zsh/.zshrc"

- name: Check if existing .zshrc exists
  stat:
    path: "{{ ansible_env.HOME }}/.zshrc"
  register: existing_zshrc

- name: Backup existing .zshrc if it exists
  copy:
    src: "{{ ansible_env.HOME }}/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc.backup-{{ ansible_date_time.epoch }}"
    remote_src: yes
  when:
    - existing_zshrc.stat.exists
  register: backup_result
  failed_when: false  # Best effort - don't fail if backup can't be created

- name: Warn if backup failed
  debug:
    msg: "WARNING: Could not backup existing .zshrc. Proceeding anyway."
  when:
    - existing_zshrc.stat.exists
    - backup_result is defined
    - backup_result.failed | default(false)

- name: Link new .zshrc
  file:
    src: "{{ dotfiles_repo }}/zsh/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc"
    state: link
    force: yes

- name: Verify .zshrc symlink was created
  stat:
    path: "{{ ansible_env.HOME }}/.zshrc"
  register: zshrc_link_check
  failed_when: not zshrc_link_check.stat.exists

- name: Ensure .zsh.d directory exists
  file:
    path: "{{ ansible_env.HOME }}/.zsh.d"
    state: directory
    mode: '0755'

- name: Include set-zsh-shell tasks
  include_tasks: set-zsh-shell.yml
  when: set_default_shell | default(true)
