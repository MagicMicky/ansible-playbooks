---
# Shell configuration tasks

- name: Load Catppuccin theme variables
  include_vars:
    file: catppuccin-mocha.yml

- name: Ensure .config/shell directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/shell"
    state: directory
    mode: '0755'

- name: Detect server type from hostname
  set_fact:
    server_type: "{{ 'prod' if (inventory_hostname is match('^(prod|production).*')) else
                     ('dev-server' if (inventory_hostname is match('^dev-.*')) else
                     ('gaming-server' if (inventory_hostname is match('^gaming.*')) else
                     ('homelab' if (inventory_hostname is match('^(homelab|home-|nas).*')) else
                     ('dedicated-server' if (inventory_hostname is match('^(dedicated|dedi-).*')) else
                     'generic')))) }}"
  when:
    - machine_profile == 'server'
    - server_type is not defined

- name: Set Starship character and color based on machine type
  set_fact:
    starship_char: "{{ '●' if machine_profile in ['server', 'homelab'] else 'λ' }}"
    starship_color: "{{ catppuccin_green if machine_profile == 'homelab' else
                        (catppuccin_mauve if machine_profile == 'server' else
                        catppuccin_sapphire) }}"

- name: Show machine configuration
  debug:
    msg: |
      Machine Profile: {{ machine_profile }}
      Server Type: {{ server_type | default('N/A - not a server') }}
      Hostname: {{ inventory_hostname }}
      Starship Character: {{ starship_char }}
      Starship Color: {{ starship_color }}

- name: Generate Starship environment configuration
  template:
    src: starship-env.zsh.j2
    dest: "{{ ansible_env.HOME }}/.config/shell/starship-env.zsh"
    mode: '0644'

- name: Generate Starship configuration with machine-specific colors
  template:
    src: starship.toml.j2
    dest: "{{ ansible_env.HOME }}/.config/starship.toml"
    mode: '0644'

- name: Set machine type marker (for documentation/debugging)
  copy:
    content: "{{ machine_profile }}"
    dest: "{{ machine_type_file }}"
    mode: '0644'
  when: machine_profile is defined

- name: Set pro profile marker (work laptop - for documentation/debugging)
  copy:
    content: ""
    dest: "{{ enable_pro_file }}"
    mode: '0644'
  when: machine_profile == "work"

- name: Check if dotfiles repository exists
  stat:
    path: "{{ dotfiles_repo }}"
  register: dotfiles_dir

- name: Clone dotfiles repository
  git:
    repo: "{{ dotfiles_repo_url }}"
    dest: "{{ dotfiles_repo }}"
    version: "{{ dotfiles_branch }}"
    update: yes
  when:
    - dotfiles_repo_url is defined
    - dotfiles_repo_url != ""
    - not dotfiles_dir.stat.exists

- name: Check if existing .zshrc exists
  stat:
    path: "{{ ansible_env.HOME }}/.zshrc"
  register: existing_zshrc

- name: Backup existing .zshrc if it exists
  copy:
    src: "{{ ansible_env.HOME }}/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc.backup-{{ ansible_date_time.epoch }}"
    remote_src: yes
  when:
    - existing_zshrc.stat.exists
  register: backup_result
  failed_when: false  # Best effort - don't fail if backup can't be created

- name: Warn if backup failed
  debug:
    msg: "WARNING: Could not backup existing .zshrc. Proceeding anyway."
  when:
    - existing_zshrc.stat.exists
    - backup_result is defined
    - backup_result.failed | default(false)

- name: Link new .zshrc
  file:
    src: "{{ dotfiles_repo }}/zsh/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc"
    state: link
    force: yes

- name: Ensure .zsh.d directory exists
  file:
    path: "{{ ansible_env.HOME }}/.zsh.d"
    state: directory
    mode: '0755'

- name: Include set-zsh-shell tasks
  include_tasks: set-zsh-shell.yml
  when: set_default_shell | default(true)
