---
# Shell configuration tasks

- name: Load Catppuccin theme variables
  include_vars:
    file: catppuccin-mocha.yml

- name: Ensure .config directory exists
  file:
    path: "{{ target_home }}/.config"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes

- name: Ensure .config/shell directory exists
  file:
    path: "{{ target_home }}/.config/shell"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes

- name: Ensure .config/bat directory exists
  file:
    path: "{{ target_home }}/.config/bat"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes

- name: Ensure .config/bat/themes directory exists
  file:
    path: "{{ target_home }}/.config/bat/themes"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes

- name: Detect server type from hostname
  set_fact:
    server_type: "{{ 'prod' if (inventory_hostname is match('^(prod|production).*')) else
                     ('dev-server' if (inventory_hostname is match('^dev-.*')) else
                     ('gaming-server' if (inventory_hostname is match('^gaming.*')) else
                     ('homelab' if (inventory_hostname is match('^(homelab|home-|nas).*')) else
                     ('dedicated-server' if (inventory_hostname is match('^(dedicated|dedi-).*')) else
                     'generic')))) }}"
  when:
    - machine_profile == 'server'
    - server_type is not defined

- name: Set Starship character and color based on machine type
  set_fact:
    starship_char: "{{ '●' if machine_profile in ['server', 'homelab'] else 'λ' }}"
    starship_color: "{{ catppuccin_green if machine_profile == 'homelab' else
                        (catppuccin_mauve if machine_profile == 'server' else
                        catppuccin_sapphire) }}"

- name: Show machine configuration
  debug:
    msg: |
      Machine Profile: {{ machine_profile }}
      Server Type: {{ server_type | default('N/A - not a server') }}
      Hostname: {{ inventory_hostname }}
      Starship Character: {{ starship_char }}
      Starship Color: {{ starship_color }}

- name: Generate Starship configuration with machine-specific colors
  template:
    src: starship.toml.j2
    dest: "{{ target_home }}/.config/starship.toml"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: yes

- name: Download Catppuccin Mocha bat theme
  get_url:
    url: "https://raw.githubusercontent.com/catppuccin/bat/main/themes/Catppuccin%20Mocha.tmTheme"
    dest: "{{ target_home }}/.config/bat/themes/Catppuccin Mocha.tmTheme"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: yes
  register: bat_theme_download
  when: not ansible_check_mode

- name: Check if bat is installed
  command: which bat
  register: bat_installed
  changed_when: false
  failed_when: false

- name: Build bat cache (only if bat is installed and theme was downloaded)
  command: bat cache --build
  become: yes
  become_user: "{{ target_user }}"
  when:
    - not ansible_check_mode
    - bat_installed.rc == 0
    - bat_theme_download.changed | default(false)
  changed_when: true

- name: Generate shell theme configuration
  template:
    src: shell-theme.zsh.j2
    dest: "{{ target_home }}/.config/shell/theme.zsh"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: yes

- name: Set machine type marker (for documentation/debugging)
  copy:
    content: "{{ machine_profile }}"
    dest: "{{ machine_type_file }}"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: yes
  when: machine_profile is defined

- name: Set pro profile marker (work laptop - for documentation/debugging)
  copy:
    content: ""
    dest: "{{ enable_pro_file }}"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: yes
  when: machine_profile == "work"

- name: Check if dotfiles repository exists
  stat:
    path: "{{ dotfiles_dest }}/.git"
  become: yes
  register: dotfiles_git_dir

- name: Ensure dotfiles parent directory exists
  file:
    path: "{{ dotfiles_dest | dirname }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes
  when:
    - dotfiles_repo_url is defined
    - dotfiles_repo_url != ""

- name: Clone dotfiles repository (if not exists)
  git:
    repo: "{{ dotfiles_repo_url }}"
    dest: "{{ dotfiles_dest }}"
    version: "{{ dotfiles_branch }}"
  become: yes
  become_user: "{{ target_user }}"
  when:
    - dotfiles_repo_url is defined
    - dotfiles_repo_url != ""
    - not dotfiles_git_dir.stat.exists

- name: Update dotfiles repository (if exists)
  git:
    repo: "{{ dotfiles_repo_url }}"
    dest: "{{ dotfiles_dest }}"
    version: "{{ dotfiles_branch }}"
    update: yes
  become: yes
  become_user: "{{ target_user }}"
  when:
    - dotfiles_repo_url is defined
    - dotfiles_repo_url != ""
    - dotfiles_git_dir.stat.exists

- name: Check if existing .zshrc exists
  stat:
    path: "{{ target_home }}/.zshrc"
  become: yes
  register: existing_zshrc

- name: Backup existing .zshrc if it exists and is not already a symlink
  copy:
    src: "{{ target_home }}/.zshrc"
    dest: "{{ target_home }}/.zshrc.backup-{{ ansible_date_time.epoch }}"
    remote_src: yes
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: preserve
  become: yes
  when:
    - existing_zshrc.stat.exists
    - not existing_zshrc.stat.islnk  # Only backup if it's NOT already a symlink
  register: backup_result
  # Fail if backup fails - we don't want to overwrite user data without backup
  failed_when: backup_result.failed | default(false)

- name: Show backup location
  debug:
    msg: "Existing .zshrc backed up to {{ target_home }}/.zshrc.backup-{{ ansible_date_time.epoch }}"
  when:
    - backup_result is defined
    - backup_result.changed | default(false)

- name: Link new .zshrc
  file:
    src: "{{ dotfiles_dest }}/zsh/.zshrc"
    dest: "{{ target_home }}/.zshrc"
    state: link
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    force: yes
  become: yes

- name: Skip global compinit on Debian/Ubuntu (saves ~400ms)
  blockinfile:
    path: "{{ target_home }}/.zshenv"
    create: yes
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - COMPINIT"
    block: |
      # Skip Ubuntu/Debian's global compinit in /etc/zsh/zshrc
      # We run our own cached compinit in .zshrc
      skip_global_compinit=1
  become: yes
  when: is_debian

- name: Ensure .zsh.d directory exists
  file:
    path: "{{ target_home }}/.zsh.d"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  become: yes

- name: Symlink core zsh config files to .zsh.d
  file:
    src: "{{ dotfiles_dest }}/zsh/core/{{ item }}"
    dest: "{{ target_home }}/.zsh.d/{{ item }}"
    state: link
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    force: yes
  become: yes
  loop:
    - 01-zinit.zsh
    - 10-path.zsh
    - 20-env.zsh
    - 25-tools.zsh
    - 30-aliases.zsh
    - 40-functions.zsh

- name: Symlink profile zsh config files to .zsh.d
  file:
    src: "{{ dotfiles_dest }}/zsh/profiles/{{ machine_profile }}/{{ item }}"
    dest: "{{ target_home }}/.zsh.d/{{ item }}"
    state: link
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    force: yes
  become: yes
  loop:
    - plugins.zsh
    - config.zsh
    - overrides.zsh

- name: Create machine type marker file
  copy:
    content: "{{ machine_profile }}"
    dest: "{{ target_home }}/.zsh.d/.machine-type"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  become: yes

- name: Include set-zsh-shell tasks
  include_tasks: set-zsh-shell.yml
  when: set_default_shell | default(true)
