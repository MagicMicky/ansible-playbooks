---
# Server Shell Configuration Playbook
# Configures modern shell environment for servers
# Base system setup (packages, Docker, users) is handled by infra repo

- name: Configure Server Shell
  hosts: all
  become: false

  vars_files:
    - vars/defaults.yml

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Configuring shell for {{ inventory_hostname }}
          Machine Profile: {{ machine_profile }}
          Dotfiles: {{ dotfiles_repo_url }}
          Branch: {{ dotfiles_branch }}

  tasks:
    # Configure shell for users with zsh
    - name: Configure shell for zsh users
      include_role:
        name: common-shell
      vars:
        target_user: "{{ server_user.name }}"
        target_home: "/home/{{ server_user.name }}"
        dotfiles_dest: "/home/{{ server_user.name }}/dotfiles"
      loop: "{{ server_users | selectattr('shell', 'defined') | selectattr('shell', 'equalto', '/bin/zsh') | list }}"
      loop_control:
        loop_var: server_user
        label: "{{ server_user.name }}"
      tags: ['shell', 'dotfiles']

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Shell configuration complete for {{ inventory_hostname }}

          Configured:
          - Machine profile: {{ machine_profile }}
          - Starship prompt
          - Modern tools (fzf, zoxide, ripgrep)
          - Dotfiles linked

          Next steps:
          - Start new shell: exec zsh
