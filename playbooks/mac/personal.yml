---
# Personal Mac Setup Playbook
# Simplified and cleaned up version - removes broken/unused components
# Focus: Modern shell setup via common-shell role + Homebrew package management

- name: Configure Personal Mac
  hosts: localhost
  connection: local

  vars_files:
    - vars/personal.yml

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Configuring Personal Mac
          Dotfiles: {{ dotfiles_repo }}
          Branch: {{ dotfiles_repo_version }}
          Machine Profile: {{ machine_profile }}

  roles:
    # Homebrew installation and package management
    - role: geerlingguy.mac.homebrew
      tags: ['homebrew', 'packages']

    # Modern shell configuration (zinit, starship, modern tools)
    - role: common-shell
      vars:
        dotfiles_repo_url: "{{ dotfiles_repo }}"
        dotfiles_branch: "{{ dotfiles_repo_version }}"
        dotfiles_dest: "{{ dotfiles_repo_local_destination | default(ansible_env.HOME ~ '/dotfiles') }}"
      tags: ['shell', 'dotfiles']

    # macOS system preferences and fonts
    - role: mac-system
      when: configure_osx | default(false)
      tags: ['osx', 'system', 'fonts']

    - role: app-config
      tags: ['apps', 'config']

  tasks:
    # Install extra packages if any are defined
    - name: Install extra packages
      ansible.builtin.import_tasks: tasks/extra-packages.yml
      when: >
        (composer_packages | default([]) | length > 0) or
        (npm_packages | default([]) | length > 0) or
        (pip_packages | default([]) | length > 0) or
        (gem_packages | default([]) | length > 0)
      tags: ['packages', 'extra']

    # Run optional post-provision tasks
    - name: Run post-provision tasks
      ansible.builtin.include_tasks: "{{ item }}"
      with_fileglob: "{{ post_provision_tasks | default([]) }}"
      tags: ['post']

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Personal Mac configuration complete!

          Next steps:
          1. Restart your terminal or run: exec zsh
          2. Verify shell: echo $MACHINE_TYPE (should be "laptop")
          3. Check prompt: Should show [λ] in sapphire blue

          Modern shell features enabled:
          - Starship prompt with λ character
          - Zinit plugin manager
          - Modern tools: fzf, zoxide, ripgrep, bat, eza, fd
          - Shell startup time: <100ms target
