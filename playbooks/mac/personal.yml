---
# Personal Mac Setup Playbook
# Replaces mac-dev-playbook/main.yml for personal machines
# Uses consolidated shared roles from ansible-playbooks/roles/

- name: Configure Personal Mac
  hosts: localhost
  connection: local

  vars_files:
    - vars/personal.yml

  handlers:
    - name: Restart Dock
      shell: killall Dock
      failed_when: false  # OK to fail: Dock may not be running (headless, CI)

  pre_tasks:
    - name: Display deployment information
      debug:
        msg: |
          Configuring Personal Mac
          Dotfiles: {{ dotfiles_repo }}
          Branch: {{ dotfiles_repo_version }}
          Machine Profile: personal

  roles:
    # Homebrew installation and package management
    - role: geerlingguy.mac.homebrew
      tags: ['homebrew', 'packages']

    # Modern shell configuration (zinit, starship, modern tools)
    - role: common-shell
      vars:
        machine_profile: personal
        dotfiles_repo_url: "{{ dotfiles_repo }}"
        dotfiles_branch: "{{ dotfiles_repo_version }}"
        dotfiles_dest: "{{ dotfiles_repo_local_destination }}"
      tags: ['shell', 'dotfiles']

    # macOS system preferences and fonts
    - role: mac-system
      when: configure_osx
      tags: ['osx', 'system', 'fonts']

    # Application configurations (Sublime, iTerm, Vim)
    - role: app-config
      tags: ['apps', 'config']

  tasks:
    - name: Setup Ansible directories
      import_tasks: ../../tasks/mac/ansible-setup.yml
      tags: ['ansible']

    - name: Configure sudoers
      import_tasks: ../../tasks/mac/sudoers.yml
      tags: ['sudoers']
      become: yes

    - name: Install extra packages
      import_tasks: ../../tasks/mac/extra-packages.yml
      tags: ['packages', 'extra']

    - name: Run post-provision tasks
      include_tasks: "{{ item }}"
      with_fileglob: "{{ post_provision_tasks | default([]) }}"
      tags: ['post']

  post_tasks:
    - name: Display completion message
      debug:
        msg: |
          Personal Mac configuration complete!

          Next steps:
          1. Restart your terminal or run: exec zsh
          2. Verify shell: echo $MACHINE_TYPE (should be "personal")
          3. Check prompt: Should show [λ] in blue

          Modern shell features enabled:
          - Starship prompt with λ character
          - Zinit plugin manager
          - Modern tools: fzf, zoxide, ripgrep, bat, eza, fd
          - Shell startup time: <100ms target
