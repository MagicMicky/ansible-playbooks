---
# WSL Setup Playbook
# Configures WSL environment with modern shell setup

- name: Configure WSL Environment
  hosts: localhost
  connection: local
  become: false

  vars_files:
    - vars/defaults.yml

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Deploying modern shell configuration to WSL
          Machine Profile: {{ machine_profile }}
          Dotfiles Location: {{ dotfiles_dest | default('~/Development/dotfiles') }}
          Branch: {{ dotfiles_branch }}

    - name: Ensure prerequisites are installed
      ansible.builtin.apt:
        name:
          - zsh
          - git
          - curl
          - wget
          - build-essential
        state: present
        update_cache: true
      become: true
      tags: ['prerequisites']

    - name: Add GitHub CLI GPG key
      ansible.builtin.apt_key:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        keyring: /usr/share/keyrings/githubcli-archive-keyring.gpg
        state: present
      become: true
      tags: ['prerequisites', 'github-cli']

    - name: Add GitHub CLI repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') }} signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        filename: github-cli
        state: present
      become: true
      tags: ['prerequisites', 'github-cli']

    - name: Install GitHub CLI
      ansible.builtin.apt:
        name: gh
        state: present
        update_cache: true
      become: true
      tags: ['prerequisites', 'github-cli']

  roles:
    - role: common-shell
      tags: ['shell', 'dotfiles']

    - role: app-config
      when: configure_apps | default(false)
      tags: ['apps', 'config']

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          WSL configuration complete!

          Next steps:
          1. Start a new shell: exec zsh
          2. Or set as default: chsh -s $(which zsh)

          On first startup:
          - Zinit will auto-install
          - Plugins will download automatically

          Your prompt should show: [Î»] in blue
