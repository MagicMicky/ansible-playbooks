name: Test Ansible Playbooks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml

      - name: Run syntax check
        run: ./tests/scripts/validate-syntax.sh

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible and ansible-lint
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/ || true
          echo "Note: Warnings are acceptable, errors should be fixed"

  test-ubuntu:
    name: Test Playbooks in Ubuntu
    runs-on: ubuntu-latest
    needs: syntax-check
    strategy:
      matrix:
        playbook:
          - playbooks/wsl/setup.yml
          - playbooks/servers/shell.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml

      - name: Run playbook (check mode)
        run: |
          if [[ "${{ matrix.playbook }}" == *"wsl"* ]]; then
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/wsl.yml --check
          else
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/ubuntu.yml --check
          fi

      - name: Run playbook (apply)
        run: |
          if [[ "${{ matrix.playbook }}" == *"wsl"* ]]; then
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/wsl.yml
          else
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/ubuntu.yml
          fi

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

  test-idempotency:
    name: Test Playbook Idempotency
    runs-on: ubuntu-latest
    needs: test-ubuntu
    strategy:
      matrix:
        playbook:
          - playbooks/wsl/setup.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml

      - name: Test idempotency
        run: |
          ./tests/scripts/test-idempotency.sh ${{ matrix.playbook }} tests/inventories/wsl.yml

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, ansible-lint, test-ubuntu, test-idempotency]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "::notice::All test jobs completed"
          if [[ "${{ needs.syntax-check.result }}" == "success" ]] && \
             [[ "${{ needs.test-ubuntu.result }}" == "success" ]] && \
             [[ "${{ needs.test-idempotency.result }}" == "success" ]]; then
            echo "✅ All tests passed!"
            exit 0
          else
            echo "❌ Some tests failed"
            exit 1
          fi
