name: Test Ansible Playbooks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Determine which tests need to run based on changed files
  check-changes:
    name: Check Changed Paths
    runs-on: ubuntu-latest
    outputs:
      run_wsl: ${{ steps.changes.outputs.run_wsl }}
      run_servers: ${{ steps.changes.outputs.run_servers }}
      run_macos: ${{ steps.changes.outputs.run_macos }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        run: |
          # Define path patterns for each platform
          WSL_PATHS='^(playbooks/wsl/|roles/common-shell/)'
          SERVER_PATHS='^(playbooks/servers/|roles/common-shell/)'
          MAC_PATHS='^(playbooks/mac/|roles/common-shell/|roles/mac-system/|roles/app-config/)'

          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger: run everything
            echo "Manual trigger - running all tests"
            echo "run_wsl=true" >> $GITHUB_OUTPUT
            echo "run_servers=true" >> $GITHUB_OUTPUT
            echo "run_macos=true" >> $GITHUB_OUTPUT
            exit 0
          else
            CHANGED=$(git diff --name-only HEAD~1)
          fi

          echo "Changed files:"
          echo "$CHANGED"
          echo ""

          # Check each platform
          if echo "$CHANGED" | grep -qE "$WSL_PATHS"; then
            echo "run_wsl=true" >> $GITHUB_OUTPUT
            echo "WSL tests: will run"
          else
            echo "run_wsl=false" >> $GITHUB_OUTPUT
            echo "WSL tests: skipped (no relevant changes)"
          fi

          if echo "$CHANGED" | grep -qE "$SERVER_PATHS"; then
            echo "run_servers=true" >> $GITHUB_OUTPUT
            echo "Server tests: will run"
          else
            echo "run_servers=false" >> $GITHUB_OUTPUT
            echo "Server tests: skipped (no relevant changes)"
          fi

          if echo "$CHANGED" | grep -qE "$MAC_PATHS"; then
            echo "run_macos=true" >> $GITHUB_OUTPUT
            echo "macOS tests: will run"
          else
            echo "run_macos=false" >> $GITHUB_OUTPUT
            echo "macOS tests: skipped (no relevant changes)"
          fi

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run syntax check
        run: ./tests/scripts/validate-syntax.sh

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible and ansible-lint
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements-ci.yml

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/wsl/ playbooks/servers/ playbooks/mac/personal.yml --force-color --parseable

  test-wsl:
    name: Test WSL Playbook
    runs-on: ubuntu-latest
    needs: [syntax-check, check-changes]
    if: needs.check-changes.outputs.run_wsl == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run playbook (check mode)
        run: ansible-playbook playbooks/wsl/setup.yml -i tests/inventories/wsl.yml --check

      - name: Run playbook (apply)
        run: ansible-playbook playbooks/wsl/setup.yml -i tests/inventories/wsl.yml

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

  test-servers:
    name: Test Server Playbook
    runs-on: ubuntu-latest
    needs: [syntax-check, check-changes]
    if: needs.check-changes.outputs.run_servers == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run playbook (check mode)
        run: ansible-playbook playbooks/servers/setup.yml -i tests/inventories/ubuntu.yml --check

      - name: Run playbook (apply)
        run: ansible-playbook playbooks/servers/setup.yml -i tests/inventories/ubuntu.yml

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

  test-wsl-idempotency:
    name: Test WSL Idempotency
    runs-on: ubuntu-latest
    needs: [test-wsl, check-changes]
    if: needs.check-changes.outputs.run_wsl == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Test idempotency
        run: ./tests/scripts/test-idempotency.sh playbooks/wsl/setup.yml tests/inventories/wsl.yml

  test-macos:
    name: Test Mac Playbook
    runs-on: macos-latest
    needs: [syntax-check, check-changes]
    if: needs.check-changes.outputs.run_macos == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: brew install zsh git wget

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run playbook (check mode)
        run: ansible-playbook playbooks/mac/personal.yml -i tests/inventories/mac.yml --check

      - name: Run playbook (apply)
        run: ansible-playbook playbooks/mac/personal.yml -i tests/inventories/mac.yml

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

      - name: Validate security
        run: ./tests/scripts/validate-security.sh

      - name: Validate tool versions
        run: ./tests/scripts/validate-tool-versions.sh

      - name: Validate profile isolation
        run: ./tests/scripts/validate-profile-isolation.sh

  test-macos-idempotency:
    name: Test Mac Idempotency
    runs-on: macos-latest
    needs: [test-macos, check-changes]
    if: needs.check-changes.outputs.run_macos == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: brew install zsh git wget

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Test idempotency
        run: ./tests/scripts/test-idempotency.sh playbooks/mac/personal.yml tests/inventories/mac.yml

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, ansible-lint, check-changes, test-wsl, test-servers, test-wsl-idempotency, test-macos, test-macos-idempotency]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "::notice::All test jobs completed"
          echo ""
          echo "Test Results:"
          echo "  Syntax Check: ${{ needs.syntax-check.result }}"
          echo "  Ansible Lint: ${{ needs.ansible-lint.result }}"
          echo ""
          echo "  WSL Tests: ${{ needs.test-wsl.result }} (run: ${{ needs.check-changes.outputs.run_wsl }})"
          echo "  WSL Idempotency: ${{ needs.test-wsl-idempotency.result }}"
          echo ""
          echo "  Server Tests: ${{ needs.test-servers.result }} (run: ${{ needs.check-changes.outputs.run_servers }})"
          echo ""
          echo "  macOS Tests: ${{ needs.test-macos.result }} (run: ${{ needs.check-changes.outputs.run_macos }})"
          echo "  macOS Idempotency: ${{ needs.test-macos-idempotency.result }}"
          echo ""

          # Syntax and lint must always pass
          if [[ "${{ needs.syntax-check.result }}" != "success" ]] || \
             [[ "${{ needs.ansible-lint.result }}" != "success" ]]; then
            echo "❌ Syntax/lint checks failed"
            exit 1
          fi

          # Platform tests must pass if they ran (skipped is OK)
          FAILED=false

          if [[ "${{ needs.check-changes.outputs.run_wsl }}" == "true" ]]; then
            if [[ "${{ needs.test-wsl.result }}" != "success" ]] || \
               [[ "${{ needs.test-wsl-idempotency.result }}" != "success" ]]; then
              echo "❌ WSL tests failed"
              FAILED=true
            fi
          fi

          if [[ "${{ needs.check-changes.outputs.run_servers }}" == "true" ]]; then
            if [[ "${{ needs.test-servers.result }}" != "success" ]]; then
              echo "❌ Server tests failed"
              FAILED=true
            fi
          fi

          if [[ "${{ needs.check-changes.outputs.run_macos }}" == "true" ]]; then
            if [[ "${{ needs.test-macos.result }}" != "success" ]] || \
               [[ "${{ needs.test-macos-idempotency.result }}" != "success" ]]; then
              echo "❌ macOS tests failed"
              FAILED=true
            fi
          fi

          if [[ "$FAILED" == "true" ]]; then
            exit 1
          fi

          echo "✅ All tests passed!"
