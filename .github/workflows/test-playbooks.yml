name: Test Ansible Playbooks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

jobs:
  # Determine which tests need to run based on changed files
  check-changes:
    name: Check Changed Paths
    runs-on: ubuntu-latest
    outputs:
      run_wsl: ${{ steps.changes.outputs.run_wsl }}
      run_servers: ${{ steps.changes.outputs.run_servers }}
      run_macos: ${{ steps.changes.outputs.run_macos }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        run: |
          # Define path patterns for each platform
          WSL_PATHS='^(playbooks/wsl/|roles/common-shell/)'
          SERVER_PATHS='^(playbooks/servers/|roles/common-shell/)'
          MAC_PATHS='^(playbooks/mac/|roles/common-shell/|roles/mac-system/|roles/app-config/)'

          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            # Manual or scheduled trigger: run everything
            echo "Manual/scheduled trigger - running all tests"
            echo "run_wsl=true" >> $GITHUB_OUTPUT
            echo "run_servers=true" >> $GITHUB_OUTPUT
            echo "run_macos=true" >> $GITHUB_OUTPUT
            exit 0
          else
            CHANGED=$(git diff --name-only HEAD~1)
          fi

          echo "Changed files:"
          echo "$CHANGED"
          echo ""

          # Check each platform
          if echo "$CHANGED" | grep -qE "$WSL_PATHS"; then
            echo "run_wsl=true" >> $GITHUB_OUTPUT
            echo "WSL tests: will run"
          else
            echo "run_wsl=false" >> $GITHUB_OUTPUT
            echo "WSL tests: skipped (no relevant changes)"
          fi

          if echo "$CHANGED" | grep -qE "$SERVER_PATHS"; then
            echo "run_servers=true" >> $GITHUB_OUTPUT
            echo "Server tests: will run"
          else
            echo "run_servers=false" >> $GITHUB_OUTPUT
            echo "Server tests: skipped (no relevant changes)"
          fi

          if echo "$CHANGED" | grep -qE "$MAC_PATHS"; then
            echo "run_macos=true" >> $GITHUB_OUTPUT
            echo "macOS tests: will run"
          else
            echo "run_macos=false" >> $GITHUB_OUTPUT
            echo "macOS tests: skipped (no relevant changes)"
          fi

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run syntax check
        run: ./tests/scripts/validate-syntax.sh

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible and ansible-lint
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements-ci.yml

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/wsl/ playbooks/servers/ playbooks/mac/personal.yml --force-color --parseable

  test-wsl:
    name: Test WSL Playbook
    runs-on: ubuntu-latest
    needs: [syntax-check, check-changes]
    if: needs.check-changes.outputs.run_wsl == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run playbook (check mode)
        run: ansible-playbook playbooks/wsl/setup.yml -i tests/inventories/wsl.yml --check

      - name: Run playbook (apply)
        run: ansible-playbook playbooks/wsl/setup.yml -i tests/inventories/wsl.yml

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

      - name: Track shell performance
        id: perf
        run: |
          mkdir -p test-results
          ./tests/scripts/track-performance.sh --check-only 2>&1 | tee test-results/wsl-performance.txt
          # Extract metrics for summary
          AVG_MS=$(grep "Average startup time" test-results/wsl-performance.txt | grep -oE '[0-9]+' || echo "N/A")
          echo "avg_ms=$AVG_MS" >> $GITHUB_OUTPUT

      - name: Add performance to job summary
        if: always()
        run: |
          echo "## üöÄ WSL Shell Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/wsl-performance.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-results/wsl-performance.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Performance test did not run" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wsl-performance-results
          path: test-results/
          retention-days: 30

  test-servers:
    name: Test Server Playbook
    runs-on: ubuntu-latest
    needs: [syntax-check, check-changes]
    if: needs.check-changes.outputs.run_servers == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run playbook (check mode)
        run: |
          ansible-playbook playbooks/servers/setup.yml -i tests/inventories/ubuntu.yml --check \
            -e '{"server_users": [{"name": "'"$(whoami)"'", "shell": "/bin/zsh"}]}'

      - name: Run playbook (apply)
        run: |
          ansible-playbook playbooks/servers/setup.yml -i tests/inventories/ubuntu.yml \
            -e '{"server_users": [{"name": "'"$(whoami)"'", "shell": "/bin/zsh"}]}'

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

      - name: Track shell performance
        id: perf
        run: |
          mkdir -p test-results
          ./tests/scripts/track-performance.sh --check-only 2>&1 | tee test-results/server-performance.txt
          # Extract metrics for summary
          AVG_MS=$(grep "Average startup time" test-results/server-performance.txt | grep -oE '[0-9]+' || echo "N/A")
          echo "avg_ms=$AVG_MS" >> $GITHUB_OUTPUT

      - name: Add performance to job summary
        if: always()
        run: |
          echo "## üöÄ Server Shell Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/server-performance.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-results/server-performance.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Performance test did not run" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-performance-results
          path: test-results/
          retention-days: 30

  test-wsl-idempotency:
    name: Test WSL Idempotency
    runs-on: ubuntu-latest
    needs: [test-wsl, check-changes]
    if: needs.check-changes.outputs.run_wsl == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Test idempotency
        run: ./tests/scripts/test-idempotency.sh playbooks/wsl/setup.yml tests/inventories/wsl.yml

  test-servers-idempotency:
    name: Test Server Idempotency
    runs-on: ubuntu-latest
    needs: [test-servers, check-changes]
    if: needs.check-changes.outputs.run_servers == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Test idempotency
        run: |
          ./tests/scripts/test-idempotency.sh playbooks/servers/setup.yml tests/inventories/ubuntu.yml \
            '{"server_users": [{"name": "'"$(whoami)"'", "shell": "/bin/zsh"}]}'

  test-macos:
    name: Test Mac Playbook
    runs-on: macos-latest
    needs: [syntax-check, check-changes]
    if: needs.check-changes.outputs.run_macos == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: brew install zsh git wget

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Run playbook (check mode)
        run: ansible-playbook playbooks/mac/personal.yml -i tests/inventories/mac.yml --check

      - name: Run playbook (apply)
        run: ansible-playbook playbooks/mac/personal.yml -i tests/inventories/mac.yml

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

      - name: Track shell performance
        id: perf
        run: |
          mkdir -p test-results
          ./tests/scripts/track-performance.sh --check-only 2>&1 | tee test-results/macos-performance.txt
          # Extract metrics for summary
          AVG_MS=$(grep "Average startup time" test-results/macos-performance.txt | grep -oE '[0-9]+' || echo "N/A")
          echo "avg_ms=$AVG_MS" >> $GITHUB_OUTPUT

      - name: Add performance to job summary
        if: always()
        run: |
          echo "## üöÄ macOS Shell Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/macos-performance.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-results/macos-performance.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Performance test did not run" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-performance-results
          path: test-results/
          retention-days: 30

      - name: Validate security
        run: ./tests/scripts/validate-security.sh

      - name: Validate tool versions
        run: ./tests/scripts/validate-tool-versions.sh

      - name: Validate profile isolation
        run: ./tests/scripts/validate-profile-isolation.sh

  test-macos-idempotency:
    name: Test Mac Idempotency
    runs-on: macos-latest
    needs: [test-macos, check-changes]
    if: needs.check-changes.outputs.run_macos == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: brew install zsh git wget

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Test idempotency
        run: ./tests/scripts/test-idempotency.sh playbooks/mac/personal.yml tests/inventories/mac.yml

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, ansible-lint, check-changes, test-wsl, test-servers, test-wsl-idempotency, test-servers-idempotency, test-macos, test-macos-idempotency]
    if: always()
    steps:
      - name: Download performance artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-performance-results'
          path: performance-results
          merge-multiple: true
        continue-on-error: true

      - name: Generate performance summary
        run: |
          echo "## üìä Shell Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Startup Time | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------------|--------|" >> $GITHUB_STEP_SUMMARY

          for platform in wsl server macos; do
            FILE="performance-results/${platform}-performance.txt"
            if [ -f "$FILE" ]; then
              AVG=$(grep "Average startup time" "$FILE" | grep -oE '[0-9]+' || echo "N/A")
              if grep -q "Performance excellent\|Performance acceptable" "$FILE"; then
                STATUS="‚úÖ Pass"
              elif grep -q "regression detected" "$FILE"; then
                STATUS="‚ö†Ô∏è Regression"
              else
                STATUS="üìä Measured"
              fi
              echo "| ${platform} | ${AVG}ms | ${STATUS} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${platform} | - | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check test results
        run: |
          echo "::notice::All test jobs completed"
          echo ""
          echo "Test Results:"
          echo "  Syntax Check: ${{ needs.syntax-check.result }}"
          echo "  Ansible Lint: ${{ needs.ansible-lint.result }}"
          echo ""
          echo "  WSL Tests: ${{ needs.test-wsl.result }} (run: ${{ needs.check-changes.outputs.run_wsl }})"
          echo "  WSL Idempotency: ${{ needs.test-wsl-idempotency.result }}"
          echo ""
          echo "  Server Tests: ${{ needs.test-servers.result }} (run: ${{ needs.check-changes.outputs.run_servers }})"
          echo "  Server Idempotency: ${{ needs.test-servers-idempotency.result }}"
          echo ""
          echo "  macOS Tests: ${{ needs.test-macos.result }} (run: ${{ needs.check-changes.outputs.run_macos }})"
          echo "  macOS Idempotency: ${{ needs.test-macos-idempotency.result }}"
          echo ""

          # Syntax and lint must always pass
          if [[ "${{ needs.syntax-check.result }}" != "success" ]] || \
             [[ "${{ needs.ansible-lint.result }}" != "success" ]]; then
            echo "‚ùå Syntax/lint checks failed"
            exit 1
          fi

          # Platform tests must pass if they ran (skipped is OK)
          FAILED=false

          if [[ "${{ needs.check-changes.outputs.run_wsl }}" == "true" ]]; then
            if [[ "${{ needs.test-wsl.result }}" != "success" ]] || \
               [[ "${{ needs.test-wsl-idempotency.result }}" != "success" ]]; then
              echo "‚ùå WSL tests failed"
              FAILED=true
            fi
          fi

          if [[ "${{ needs.check-changes.outputs.run_servers }}" == "true" ]]; then
            if [[ "${{ needs.test-servers.result }}" != "success" ]] || \
               [[ "${{ needs.test-servers-idempotency.result }}" != "success" ]]; then
              echo "‚ùå Server tests failed"
              FAILED=true
            fi
          fi

          if [[ "${{ needs.check-changes.outputs.run_macos }}" == "true" ]]; then
            if [[ "${{ needs.test-macos.result }}" != "success" ]] || \
               [[ "${{ needs.test-macos-idempotency.result }}" != "success" ]]; then
              echo "‚ùå macOS tests failed"
              FAILED=true
            fi
          fi

          if [[ "$FAILED" == "true" ]]; then
            exit 1
          fi

          echo "‚úÖ All tests passed!"
