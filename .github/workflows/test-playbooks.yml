name: Test Ansible Playbooks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors
        # Note: --ignore-errors allows work-tasks (private repo) to fail
        # We only test public playbooks (wsl, servers) in CI

      - name: Run syntax check
        run: ./tests/scripts/validate-syntax.sh

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible and ansible-lint
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors || true
        # Note: --ignore-errors + || true allows work-tasks (private repo) to fail
        # We only lint public playbooks (wsl, servers, mac) in CI

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/ --force-color --parseable
          # Using .ansible-lint config: warnings allowed, errors fail the build

  test-ubuntu:
    name: Test Playbooks in Ubuntu
    runs-on: ubuntu-latest
    needs: syntax-check
    strategy:
      matrix:
        playbook:
          - playbooks/wsl/setup.yml
          - playbooks/servers/shell.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors
        # Note: --ignore-errors allows work-tasks (private repo) to fail
        # We only test public playbooks (wsl, servers) in CI

      - name: Run playbook (check mode)
        run: |
          if [[ "${{ matrix.playbook }}" == *"wsl"* ]]; then
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/wsl.yml --check
          else
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/ubuntu.yml --check
          fi

      - name: Run playbook (apply)
        run: |
          if [[ "${{ matrix.playbook }}" == *"wsl"* ]]; then
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/wsl.yml
          else
            ansible-playbook ${{ matrix.playbook }} -i tests/inventories/ubuntu.yml
          fi

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

  test-idempotency:
    name: Test Playbook Idempotency
    runs-on: ubuntu-latest
    needs: test-ubuntu
    strategy:
      matrix:
        playbook:
          - playbooks/wsl/setup.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl wget build-essential

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors
        # Note: --ignore-errors allows work-tasks (private repo) to fail
        # We only test public playbooks (wsl, servers) in CI

      - name: Test idempotency
        run: |
          ./tests/scripts/test-idempotency.sh ${{ matrix.playbook }} tests/inventories/wsl.yml

  test-macos:
    name: Test Mac Playbooks
    runs-on: macos-latest
    needs: syntax-check
    strategy:
      matrix:
        playbook:
          - playbooks/mac/personal.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          # Install zsh (usually pre-installed on macOS)
          brew install zsh git wget

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors
        # Note: --ignore-errors allows work-tasks (private repo) to fail

      - name: Run playbook (check mode)
        run: |
          ansible-playbook ${{ matrix.playbook }} -i tests/inventories/mac.yml --check

      - name: Run playbook (apply)
        run: |
          ansible-playbook ${{ matrix.playbook }} -i tests/inventories/mac.yml

      - name: Validate shell configuration
        run: ./tests/scripts/validate-shell.sh

      - name: Validate security
        run: ./tests/scripts/validate-security.sh

      - name: Validate tool versions
        run: ./tests/scripts/validate-tool-versions.sh

      - name: Validate profile isolation
        run: ./tests/scripts/validate-profile-isolation.sh

  test-macos-idempotency:
    name: Test Mac Idempotency
    runs-on: macos-latest
    needs: test-macos
    strategy:
      matrix:
        playbook:
          - playbooks/mac/personal.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install system dependencies
        run: |
          brew install zsh git wget

      - name: Install Galaxy dependencies
        run: ansible-galaxy install -r requirements.yml --ignore-errors

      - name: Test idempotency
        run: |
          ./tests/scripts/test-idempotency.sh ${{ matrix.playbook }} tests/inventories/mac.yml

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, ansible-lint, test-ubuntu, test-idempotency, test-macos, test-macos-idempotency]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "::notice::All test jobs completed"
          echo ""
          echo "Test Results:"
          echo "  Syntax Check: ${{ needs.syntax-check.result }}"
          echo "  Ansible Lint: ${{ needs.ansible-lint.result }}"
          echo "  Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
          echo "  Ubuntu Idempotency: ${{ needs.test-idempotency.result }}"
          echo "  macOS Tests: ${{ needs.test-macos.result }}"
          echo "  macOS Idempotency: ${{ needs.test-macos-idempotency.result }}"
          echo ""

          if [[ "${{ needs.syntax-check.result }}" == "success" ]] && \
             [[ "${{ needs.ansible-lint.result }}" == "success" ]] && \
             [[ "${{ needs.test-ubuntu.result }}" == "success" ]] && \
             [[ "${{ needs.test-idempotency.result }}" == "success" ]] && \
             [[ "${{ needs.test-macos.result }}" == "success" ]] && \
             [[ "${{ needs.test-macos-idempotency.result }}" == "success" ]]; then
            echo "✅ All tests passed!"
            echo "  - Ubuntu (WSL + Server): ✅"
            echo "  - macOS (Personal): ✅"
            echo "  - Idempotency (all platforms): ✅"
            exit 0
          else
            echo "❌ Some tests failed"
            exit 1
          fi
